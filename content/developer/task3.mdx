---
title: "Task 3 — Exchange Connector"

description: Info on Exchange connector
---

import Callout from "../../src/components/Callout";

## Overview

The **_Class Diagram_**, given below, details the critical variables and functions in the `Exchange` class. The primary bulk of implementing a new exchange connector is in this task.

The functions of the `Exchange` class can be catergorized into:

[**(1) Placing Orders**](#1-placing-orders)<br/>
[**(2) Cancelling Orders**](#2-cancelling-orders)<br/>
[**(3) Tracking Orders & Balances**](#3-tracking-orders--balances)<br/>
[**(4) Managing Trading Rules**](#4-managing-trading-rules)<br/>
[**(5) Additional Functions**](#5-additional-functions)<br/>
[**(6) Class Properties**](#6-class-properties)

Although this might seem pretty straightforward, it does require a certain level of understanding and knowing the expected side-effect(s) of certain functions.

![ExchangeUMLDiagram](/img/exchange-class.svg)

<Callout
  type="note"
  body="The 4 categories of functions broadly covers the necessary functions that need to be implemented in the `Exchange` class, so feel free to include other utility functions as needed."
/>

## (1) Placing Orders

The `Exchange` class places orders by either calling the [`buy()`](#buy) or [`sell()`](#sell) method.
Both these methods first generates a client order ID for the order which will be used locally by Hummingbot to track the orders before calling the [`_create_order()`](#async-_create_order) method.

### `buy()`

Function that takes the strategy inputs, generates a client order ID(used by Hummingbot for local order tracking), and places a **buy** order by calling the [`_create_order()`](#async-_create_order) function.

**Input Parameter(s):**

| Parameter(s)   | Type        | Description                                                                               |
| -------------- | ----------- | ----------------------------------------------------------------------------------------- |
| `trading_pair` | `str`       | Name of the trading pair symbol(in Hummingbot's format i.e. `BASE-QUOTE`)                 |
| `price`        | `Decimal`   | Price in which the order will be placed in `Decimal`                                      |
| `amount`       | `Decimal`   | Amount in which the order will be placed in `Decimal`                                     |
| `order_type`   | `OrderType` | Specifies the order type of the order(i.e. `OrderType.LIMIT` and `OrderType.LIMIT_MAKER`) |

**Expected Output(s):** order_id: `str`

| Output(s)  | Type  | Description     |
| ---------- | ----- | --------------- |
| `order_id` | `str` | Client Order ID |

### `sell()`

Function that takes the strategy inputs, generates a client order ID(used by Hummingbot for local order tracking), and places a **sell** order by calling the [`_create_order()`](#async-_create_order) function.

**Input Parameter(s):**

| Parameter(s)   | Type        | Description                                                                               |
| -------------- | ----------- | ----------------------------------------------------------------------------------------- |
| `trading_pair` | `str`       | Name of the trading pair symbol(in Hummingbot's format i.e. `BASE-QUOTE`)                 |
| `price`        | `Decimal`   | Price in which the order will be placed in `Decimal`                                      |
| `amount`       | `Decimal`   | Amount in which the order will be placed in `Decimal`                                     |
| `order_type`   | `OrderType` | Specifies the order type of the order(i.e. `OrderType.LIMIT` and `OrderType.LIMIT_MAKER`) |

**Expected Output(s):**

| Output(s)  | Type  | Description     |
| ---------- | ----- | --------------- |
| `order_id` | `str` | Client Order ID |

<!-- 
<details>
  <summary><p style="display:inline"><strong>Input Parameter(s):</strong></p></summary>


| Parameter(s)   | Type        | Description                                                                               |
| -------------- | ----------- | ----------------------------------------------------------------------------------------- |
| `trading_pair` | `str`       | Name of the trading pair symbol(in Hummingbot's format i.e. `BASE-QUOTE`)                 |
| `price`        | `Decimal`   | Price in which the order will be placed in `Decimal`                                      |
| `amount`       | `Decimal`   | Amount in which the order will be placed in `Decimal`                                     |
| `order_type`   | `OrderType` | Specifies the order type of the order(i.e. `OrderType.LIMIT` and `OrderType.LIMIT_MAKER`) |

</details>


<details>
  <summary><p style="display:inline"><strong>Expected Output(s):</strong></p></summary> 




</details>
-->


### **_async_** `_create_order()`

This function is responsible for executing the API request to place the order on the exchange. It does the following:

- Verifies that the orders would be legal based on the trading rules pulled from the exchange.
- Quantize the order amount to ensure that the precision is as required by the exchange.
- Create a `params` dictionary with the necessary parameters for the desired order.
- Pass the `params` to an `Auth` object to generate the request signature.
- Begin tracking the order by calling [`start_tracking_order(...)`](#start_tracking_order).
- Places the order by calling the [`_api_request()`](#async-_api_request) method with the relevant order parameters.
- Upon successfully placing the order, the tracked order will be updated with the resulting **_exchange order ID_** from the API Response.

<Callout
  type="note"
  body="The tracked order is an `InFlightOrder` that is within a dictionary variable(`_in_flight_orders`) in the `Exchange` class. `InFlightOrder` are Hummingbot’s internal records of orders it has placed that remain open in the exchange. 
  When such orders are either filled or canceled, they are removed from the dictionary by calling [stop_tracking_order()] method, and the relevant event completion flag is passed to the strategy module."
  link={["#stop_tracking_order"]}
/>

**Input Parameter(s):**

| Parameter(s)   | Type                                                                                                       | Description                                                                               |
| -------------- | ---------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------- |
| `order_id`     | `str`                                                                                                      | ID used to track an order in Hummingbot.                                                  |
| `trading_pair` | `str`                                                                                                      | Name of the trading pair symbol(in Hummingbot's format i.e. `BASE-QUOTE`)                 |
| `price`        | `Decimal`                                                                                                  | Price in which the order will be placed in `Decimal`                                      |
| `amount`       | `Decimal`                                                                                                  | Amount in which the order will be placed in `Decimal`                                     |
| `order_type`   | [`OrderType`](https://github.com/CoinAlpha/hummingbot/blob/master/hummingbot/core/event/events.py#L61-L69) | Specifies the order type of the order(i.e. `OrderType.LIMIT` and `OrderType.LIMIT_MAKER`) |
| `trade_type`   | [`TradeType`](https://github.com/CoinAlpha/hummingbot/blob/master/hummingbot/core/event/events.py#L61-L69) | Specifies the trade type of the order(i.e. `TradeType.BUY` and `TradeType.SELL`)          |

**Expected Output(s):**

| Output(s)  | Type  | Description     |
| ---------- | ----- | --------------- |
| `order_id` | `str` | Client Order ID |

## (2) Cancelling Orders

The strategy and the `exit` command cancels orders by calling [`cancel()`](#cancel) or [`cancel_all()`](#async-cancel_all) methods respectively.

### `cancel()`

Function that takes in the trading pair and client order ID from the strategy as inputs and proceeds to a **cancel** the order by calling the [`_execute_cancel()`](#async-_execute_cancel) function.

**Input Parameter(s):**

| Parameter(s)   | Type  | Description                                                               |
| -------------- | ----- | ------------------------------------------------------------------------- |
| `trading_pair` | `str` | Name of the trading pair symbol(in Hummingbot's format i.e. `BASE-QUOTE`) |
| `order_id`     | `str` | Client Order ID                                                           |

**Expected Output(s):** order_id: `str`

### **_async_** `cancel_all()`

Function that is primarily triggered by the `ExitCommand` that **cancels all** `InFlightOrder`s being tracked by the `Exchange` class. It confirms the successful cancellation of the orders by calling the

Calls the [\_api_request()](#async-_api_request) function with the relevant parameters.

**Input Parameter(s):** `None`

**Expected Output(s):**

| Output(s)             | Type                       | Description                                                                                                                                                    |
| --------------------- | -------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `cancellation_result` | `List[CancellationResult]` | List of `CancellationResult`. `CancellationResult.success` is assigned `True` if the particular order(identified by Client Order ID) is successfully cancelled |

<Callout
  type="note"
  body="In some cases, where an exchange does not have a cancel all orders endpoint, the we will have to call `_execute_cancel()` for each in-flight order"
/>

### **_async_** `_execute_cancel()`

Cancels the specified in-flight order and simply returns the client order ID.

**Input Parameter(s):**

| Parameter(s)   | Type  | Description                                                               |
| -------------- | ----- | ------------------------------------------------------------------------- |
| `trading_pair` | `str` | Name of the trading pair symbol(in Hummingbot's format i.e. `BASE-QUOTE`) |
| `order_id`     | `str` | Client Order ID                                                           |

**Expected Output(s):**

| Output(s)  | Type  | Description     |
| ---------- | ----- | --------------- |
| `order_id` | `str` | Client Order ID |

## (3) Tracking Orders & Balances

The functions listed in this section details how the connector should process and track orders and balances.

### `start_tracking_order()`

Starts tracking an order by simply adding it into `_in_flight_orders` dictionary.

**Input Parameter(s):**

| Parameter(s)        | Type                                                                                                       | Description                                                                               |
| ------------------- | ---------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------- |
| `order_id`          | `str`                                                                                                      | ID used to track an order in Hummingbot.                                                  |
| `exchange_order_id` | `str`                                                                                                      | ID used to uniquely identify the order on the Exchange.                                   |
| `trading_pair`      | `str`                                                                                                      | Name of the trading pair symbol(in Hummingbot's format i.e. `BASE-QUOTE`)                 |
| `price`             | `Decimal`                                                                                                  | Price in which the order will be placed in `Decimal`                                      |
| `amount`            | `Decimal`                                                                                                  | Amount in which the order will be placed in `Decimal`                                     |
| `order_type`        | [`OrderType`](https://github.com/CoinAlpha/hummingbot/blob/master/hummingbot/core/event/events.py#L61-L69) | Specifies the order type of the order(i.e. `OrderType.LIMIT` and `OrderType.LIMIT_MAKER`) |
| `trade_type`        | [`TradeType`](https://github.com/CoinAlpha/hummingbot/blob/master/hummingbot/core/event/events.py#L61-L69) | Specifies the trade type of the order(i.e. `TradeType.BUY` and `TradeType.SELL`)          |

**Expected Output(s):** `None`

<Callout
  type="note"
  body="In most cases, the `exchange_order_id` is only provided after the place order APi request is succesfully processed by the exchange. As such, the `exchange_order_id` can be `None` initially.
  It can be updated later by using the [InFlightOrderBase.update_exchange_order_id()] function."
  link={[
    "https://github.com/CoinAlpha/hummingbot/blob/master/hummingbot/connector/in_flight_order_base.pyx#L77-L79",
  ]}
/>

### `stop_tracking_order()`

Stops tracking an order by simply removing it from `_in_flight_orders` dictionary.

**Input Parameter(s):**

| Parameter(s) | Type  | Description                              |
| ------------ | ----- | ---------------------------------------- |
| `order_id`   | `str` | ID used to track an order in Hummingbot. |

**Expected Output(s):** `None`

### **_async_** `_user_stream_event_listener()`

Wait for new messages from `_user_stream_tracker.user_stream` queue and processes them according to their message channels.
These messages are queued by the respective `UserStreamDataSource`.

Below are the function(s) called from within `_user_stream_event_listener()` when a message is received.

| Function(s)                                              | Description                           |
| -------------------------------------------------------- | ------------------------------------- |
| [\_process_order_message()](#_process_order_message)     | Process user's order update messages. |
| [\_process_trade_message()](#_process_trade_message)     | Process user's trade messages.        |
| [\_process_balance_message()](#_process_balance_message) | Process user's balance messages.      |

**Input Parameter(s):** `None`

**Expected Output(s):** `None`

### `_status_polling_loop()`

Periodically update user balances and order status via REST API. This serves as a fallback measure for websocket API updates.
Calling of both [\_update_balances()](#_update_balances) and [\_update_order_status()](#_update_order_status) functions is determined by the `_poll_notifier` variable.

`_poll_notifier` is an `asyncio.Event` object that is set in the `tick()` function.
It is set after every `SHORT_POLL_INTERVAL` or `LONG_POLL_INTERVAL` depending on the `last_recv_time` of the `_user_stream_tracker`.

**Input Parameter(s):** `None`

**Expected Output(s):** `None`

### `_update_balances()`

Calls the REST API to update total and available balances.

**Input Parameter(s):** `None`

**Expected Output(s):** `None`

### `_update_order_status()`

Calls the REST API to get order/trade updates for each in-flight order.

If needed, it will call either [\_process_order_message()](#_process_order_message) or [\_process_trade_message()](#_process_trade_message) or both.

<Callout
  type="note"
  bullets={[
    "`_process_trade_message()` must be called before `_process_order_message()` for any in-flight orders.",
    "Each partial fill should be accompanied by a call to `_process_trade_message()`. This ensures that Hummingbot captures every trade executed on an order.",
  ]}
/>

**Input Parameter(s):** `None`

**Expected Output(s):** `None`

### `_process_order_message()`

Updates the in-flight order's order status and triggers the `OrderCancelledEvent` if needed.

**Input Parameter(s):**

| Parameter(s) | Type             | Description                                           |
| ------------ | ---------------- | ----------------------------------------------------- |
| `order_msg`  | `Dict[str, Any]` | The order response from either REST or websocket API. |

**Expected Output(s):** `None`

### `_process_trade_message()`

Updates in-flight order trade information by calling the `NewInFlightOrder.update_with_trade_update()` function and triggers the `OrderFilledEvent` .

It will also trigger either `BuyOrderCompletedEvent` or `SellOrderCompletedEvent` if needed.

**Input Parameter(s):**

| Parameter(s) | Type             | Description                                                   |
| ------------ | ---------------- | ------------------------------------------------------------- |
| `order_msg`  | `Dict[str, Any]` | The trade history response from either REST or websocket API. |

**Expected Output(s):** `None`

### `_process_balance_message()`

Updates the user's available and total asset balance.

**Input Parameter(s):**

| Parameter(s)  | Type             | Description                                                  |
| ------------- | ---------------- | ------------------------------------------------------------ |
| `balance_msg` | `Dict[str, Any]` | The user balance response from either REST or websocket API. |

**Expected Output(s):** `None`

## (4) Managing Trading Rules

TBD

### `get_order_price_quantum()`

### `get_order_size_quantum()`

### **_async_** `_trading_rules_polling_loop()`

### **_async_** `_update_trading_rules()`

### `_format_trading_rules()`

## (5) Additional Function(s)

TBD

### **_async_** `_api_request()`

## (6) Class Properties

TBD

## Debugging & Testing

As part of the QA process, for each tasks(Task 1 through 3) you are **required** to include the unit test cases for the code review process to begin. Refer to [Option 1: Unit Test Cases](/developer/debug&test/#option-1-unit-test-cases) to build your unit tests.
