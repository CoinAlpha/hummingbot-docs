---
title: Perpetual Market Making
description: Learn how to use Perpetual market making strategy
---

import Callout from "../../src/components/Callout";
import Prompt from "../../src/components/Prompt";


## How It Works

Perpetual market making allows Hummingbot users to market make on supported derivatives exchanges. Position management features are introduced to configure the bot further to make managing positions easier and remove the need to interact with the derivative exchange manually.

Similar to pure market making strategy, it keeps placing limit buy and sell orders on the order book and waits for other participants (takers) to fill its orders.

In this document, we will explain how the strategy works by dividing it into three main behaviors:

1. Creating orders to open a position
2. Opening positions after a filled order event
3. Creating orders to close a position

You can also watch the recording of our demo of the strategy in the link below:

- [Hummingbot Live - Perpetual Market Making Demo](https://www.youtube.com/watch?v=IclhZWtKiSA&t=2194s)

<Callout
  type="info"
  body="Currently, this strategy `only works with Binance Futures` and we plan to support more derivatives connector in the future."
/>


## Testing The Strategy

Users can test how this strategy works without risking real funds by connecting their Binance Futures Testnet account to Hummingbot.

- [Create a free account with Binance Futures Testnet](https://testnet.binancefuture.com/en/register?source=futures)
- [Creating Binance Futures Testnet API Keys](https://docs.hummingbot.io/exchange-connectors/binance-futures/#creating-binance-futures-testnet-api-keys)


## Creating a basic strategy configuration

1. Make sure to connect to an exchange supported by Perpetual Market Making strategy.
- [How to use the `connect` command to connect your API keys](/operation/command-ref/#connect)
2. Run the `create` command and enter `perpetual_market_making` when prompted for the strategy you want to use
3. Enter the name of the connector and the trading pair you want to use with this strategy
4. Enter how much [`leverage`](#leverage) you want to use. Leverage allows you to open a position with a fraction of a cost. The higher the leverage, the higher the risk. Please manage accordingly.
5. Select a [`position_mode`](#position_mode) from either One-way or Hedge mode. These are both explained further in their respective sections below.
6. Enter the amount of orders you want to place in `order_amount` prompt
7. Select a `position_management` from either `Profit_taking` or `Trailing_stop` value
8. If you selected `Profit_taking`, enter the spreads of your profit taking orders to close a long or short position in `long_profit_taking_spread` `short_profit_taking_spread`
9. If you selected `Trailing_stop`, enter the spread when you want the bot to start trailing as `ts_activation_spread` and the exit price as `ts_callback_rate`
10. Enter the spread from entry price to close a position with a stop loss order
11. Choose between limit or market order when `close_position_order_type` value for stop loss and trailing stop orders
12. The strategy configuration file is saved in the Hummingbot folder
- [Where are my configuration files saved?](https://hummingbot.zendesk.com/hc/en-us/articles/900005206343-Where-is-my-config-and-log-file-)


## Creating orders to open a position

Initially, a limit buy and sell order are created based on `bid_spread` and `ask_spread` settings. This determines the entry price of the position we will open later.

**What happens if both my orders are not filled?**

If the orders are not filled when they reach `order_refresh_time`, they are cancelled and a new set of orders are created to ensure our orders are refreshed based on our specified bid/ask spread.

With the exception of `order_refresh_tolerance_pct` value, if the orders are within the tolerable change in spread then they are not cancelled. A log message on the right pane will show “Not cancelling active orders since difference between the new order prices and current order prices is within order_refresh_tolerance_pct”.

**If one of my orders is filled, what happens to the opposite order that was not filled?**

In `One-way` mode, if an order is filled the opposite order is cancelled. For example, if your buy order is filled it opens a LONG position, cancels the opening sell order and creates a closing sell order.

In `Hedge` mode, if one order is filled the opposite order is not cancelled. For example, if your buy order is filled it opens a LONG position and creates another closing sell order. The opening sell order that was initially created remains active waiting to get filled so it can open a SHORT position simultaneously.


## Opening positions after a filled order event
The strategy uses the filled order’s price as the entry price of the position. The number of positions you can open depends on the `position_mode` selected:

### One-way mode

In `One-way` mode, only one position can be opened i.e. you only have either a LONG or a SHORT position.

### Hedge mode

In `Hedge` mode, two positions can be opened simultaneously i.e. you can have one LONG and one SHORT position.


## Creating orders to close a position

Positions are closed in three ways:

1. Profit taking orders are filled (for `Profit_taking` position management)
2. Market falls to or below the estimated exit price (for `Trailing_stop` position management)
3. Stop loss is triggered because profitability falls to or below the `stop_loss_spread` value

### Profit Taking

Hummingbot creates a sell order to close a long position and a buy order to close a short position. If these orders are filled, the position is closed.

Sample scenario:

```
position_mode: Profit_taking
long_profit_taking_spread: 5
short_profit_taking_spread: 1
```

If the price of your filled buy order is $10,000 then it opens a long position with that entry price. If your `long_profit_taking_spread` is set to 5% it will create a profit taking sell order at $10,500.

If the price of your filled sell order is $10,000 it opens a short position. The bot will create a profit taking buy order at $9,900 because our `short_profit_taking_spread` is set to 1% value.

### Trailing Stop

This position management allows users to maximize the profitability of a position. When an order is filled and a position is opened, it waits for PNL to reach the `ts_activation_spread` to start trailing. If this value is set to 0, the bot starts trailing immediately as soon as the order is filled.

Trailing is when Hummingbot monitors for the market’s peak price and determines your exit price based on `ts_callback_rate` value.

Sample scenario:

```
ts_activation_spread: 10
ts_callback_rate: 5
```

Let’s say your buy order is filled again at $10,000 and opens a long position. It waits for the best sell price to reach $11,000 (10% from the entry price) before the bot can start trailing by monitoring for the peak price. The market went down to $10,500 the next minute and went up again to $12,000. So this time, our new peak price is $12,000 and our exit price is $11,400 (5% callback rate).

When the market falls to or below $11,400 the bot will create a limit or market (depending on `close_positon_order_type` value) sell order to close the position.

### Stop Loss

If the position’s profitability (PNL) is equal to or below the `stop_loss_spread`, the bot will create a limit or market order (depending on `close_positon_order_type` value) at the current mark price to close the position.

If there are outstanding limit orders, they are cancelled and replaced with a stop loss order. 

**Why is my bot not creating orders to close a position?**

The strategy includes a logic that it will not create these orders when the position is at a loss (PNL or ROE at negative value). In the sample screenshot below, you can see that we have an open long position but no open orders because PNL (ROE%) is at a loss.

[placeholder]()

These are the logs in Hummingbot. Notice that our position was opened at 08:18:47 when our first buy order was filled but only created the second order to lock profit at 08:45:38 when our PNL went up to a positive value.

[placeholder]()
[placeholder]()
[placeholder]()

**Estimated exit price is Nill USDT when using trailing stop**

Price NILL means the exit price is not profitable based on the current peak price.

[placeholder]()

**What is the difference between using LIMIT and MARKET order type?**

Most of us are aware that submitting a market order instantly executes a trade by taking the best order in the order book while a limit order is an order that you place on the order book (taker) with a specific limit price, waiting for someone to fill that order therefore adding liquidity to the market.

Taker fees are typically higher than maker fees in most exchanges.

- [Fee Schedule of Binance Futures](https://www.binance.com/en/support/faq/360033544231)

Some users use LIMIT order type for stop loss or trailing stop orders to close a position to take advantage of the maker fees, while some users use MARKET order type in case of network connectivity problems.

If you’re running the bot or strategy on a machine with poor network connection, chances are the order book prices will not be updated right away which could affect your limit order prices and your positions might be closed at the profitability you were not expecting.

Using market order type helps ensure that your positions are closed at mark price but paying higher fees.
